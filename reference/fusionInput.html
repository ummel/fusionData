<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content='Handles all operations needed to generate /input files from successfully ingested and harmonized donor survey microdata. Optionally uploads resulting local /input data files to correct location in remote storage (via uploadFiles).
!!! Argument test_mode = TRUE by default, which causes local "/fusion_" sub-directory to be used (creating it if necessary). This prevents any overwrite of production data in "/fusion" (no underscore) while in test mode.'><title>Generate input files needed for fusion — fusionInput • fusionData</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Generate input files needed for fusion — fusionInput"><meta property="og:description" content='Handles all operations needed to generate /input files from successfully ingested and harmonized donor survey microdata. Optionally uploads resulting local /input data files to correct location in remote storage (via uploadFiles).
!!! Argument test_mode = TRUE by default, which causes local "/fusion_" sub-directory to be used (creating it if necessary). This prevents any overwrite of production data in "/fusion" (no underscore) while in test mode.'><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">fusionData</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"></ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Generate input files needed for fusion</h1>
      
      <div class="d-none name"><code>fusionInput.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Handles all operations needed to generate <code>/input</code> files from successfully ingested and harmonized donor survey microdata. Optionally uploads resulting local <code>/input</code> data files to correct location in remote storage (via <code><a href="uploadFiles.html">uploadFiles</a></code>).
<br><br>!!! Argument <code>test_mode = TRUE</code> by default, which causes local "/fusion_" sub-directory to be used (creating it if necessary). This prevents any overwrite of production data in "/fusion" (no underscore) while in test mode.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">fusionInput</span><span class="op">(</span></span>
<span>  <span class="va">donor</span>,</span>
<span>  <span class="va">recipient</span>,</span>
<span>  <span class="va">respondent</span>,</span>
<span>  fuse <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  force <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  note <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  test_mode <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  ncores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"fusionData.cores"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>donor</dt>
<dd><p>Character. Donor survey identifier (e.g. <code>"RECS_2015"</code>).</p></dd>


<dt>recipient</dt>
<dd><p>Character. Recipient (ACS) survey identifier (e.g. <code>"ACS_2015"</code>).</p></dd>


<dt>respondent</dt>
<dd><p>Character. Desired respondent level of microdata. Either <code>"household"</code> or <code>"person"</code>.</p></dd>


<dt>fuse</dt>
<dd><p>Character or list. Names of donor variables to be fused to recipient. If <code>fuse</code> is a list, each entry is a character vector possibly indicating multiple variables to fuse as a block. The order of the <code>fuse</code> variables does not matter, since <code>prepXY</code> is used internally to determine a plausible fusion sequence. If NULL (default), an attempt is made to return all donor variables not used in predictor harmonization process.</p></dd>


<dt>force</dt>
<dd><p>Character. Pre-specified subset of potential predictor variables to "force" as included predictors. These variables are also used within <code><a href="fusionOutput.html">fusionOutput</a></code> to create validation subsets. We generally select the variables that best reflect the following socioeconomic and geographic concepts: income; race/ethnicity; education; household size; housing tenure; and the highest-resolution location variable for which the donor survey is thought to be representative.</p></dd>


<dt>note</dt>
<dd><p>Character. Optional note supplied by user. Inserted in the log file for reference.</p></dd>


<dt>test_mode</dt>
<dd><p>Logical. If <code>TRUE</code> (default), function uses the local "/fusion_" sub-directory (creating it if necessary). Only when <code>test_mode = FALSE</code> is it possible to overwrite production data in "/fusion" (no underscore).</p></dd>


<dt>ncores</dt>
<dd><p>Integer. Number of physical CPU cores used for parallel computation.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>Invisibly returns path to local directory where files were saved. Messages printed to console noting progress. Resulting <code>/input</code> data files are saved to appropriate local directory and (optionally) to remote Google Drive storage. Also saves a .txt log file alongside data files that records console output from <code>fusionInput</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The function checks arguments and determines the file path to the appropriate <code>/input</code> directory (creating it if necessary), based on <code>donor</code>, <code>recipient</code>, <code>respondent</code>, and <code>test_mode</code>. It then executes the following steps:</p><ol><li><p><strong>Check for custom pre-processing script</strong>. Looks for an <em>optional</em>, pre-existing .R script in <code>/input</code> starting with "(00)". This script can be used to inject custom code prior to any other operations. Most likely, the custom code is used to set or modify function arguments that cannot be specified manually at function call. If found, the .R file is <code><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></code>-d locally and code comments are printed to the console.</p></li>
<li><p><strong>prepare() microdata</strong>. <code><a href="prepare.html">prepare</a></code> is called with sensible default values.</p></li>
<li><p><strong>assemble() microdata</strong>. <code><a href="assemble.html">assemble</a></code> is called with sensible default values. Output from <code><a href="assemble.html">assemble</a></code> consists of an object named <code>data</code> with the harmonized donor microdata in <code>data[[1]]</code> and harmonized ACS microdata in <code>data[[2]]</code>.</p></li>
<li><p><strong>Check for custom .R scripts</strong>. Looks for <em>optional</em>, pre-existing .R scripts in <code>/input</code> starting with "(01)", "(02)", etc. These scripts can be used to inject custom code prior to next step. Most likely, the custom code is used to add or remove non-standard variables from <code>data</code> or otherwise adjust the default harmonized microdata. The custom code must modify the <code>fuse</code> vector (or list) if changes to the initial function argument are desired. If found, the .R files are <code><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></code>-d locally and code comments are printed to the console.</p></li>
<li><p><strong>Check categorical harmonized variables</strong>. Computes the similarity of donor and ACS categorical harmonized variables by comparing proportions for the observable factor levels. Under the assumption that the donor and ACS sample the same underlying population, we expect the proportions to be fairly similar. Returns a "Similarity score" for each categorical harmonized variable, ranging from 0 to 1. Variables with scores below ~0.8 should probably be checked by the analyst (via <code><a href="harmony.html">harmony</a></code>) to confirm that the harmonization strategy is valid. User is prompted in the console to indicate which variables should be ignored/dropped/removed, if any.</p></li>
<li><p><strong>Check location variables</strong>. Checks the number of factor levels in each location predictor variable and compares to the number of levels in the "representative" location variable passed via <code>force</code>. If a location variable has more levels than the representative one, it is flagged as a potential issue since it suggests the presence of a location variable with greater spatial resolution than the one known to be representative. User is prompted in the console to indicate if they would like to remove the flagged variable(s).</p></li>
<li><p><strong>Check fusion and predictor variables</strong>. The full set of fusion and potential predictor variables is determined. Summary information is printed to the console. User is prompted in the console to confirm that everything looks OK before proceeding.</p></li>
<li><p><strong>Run fusionModel::prepXY()</strong>. <code>prepXY</code> is called with sensible default values. The output is written to the appropriate <code>/input</code> directory and noted in console. <code>prepXY</code> argument <code>fraction</code> is automatically set to use 10% of donor observations or 50k rows (10k in test mode), whichever is higher. Sampling often has minimal effect on results but speeds up computation.</p></li>
<li><p><strong>Write training and prediction datasets to disk</strong>. The (donor) training and (ACS) prediction datasets are written to the appropriate <code>/input</code> directory as fully-compressed <code><a href="http://www.fstpackage.org/reference/fst.html" class="external-link">fst</a></code> files. Output file names noted in console. In test mode, no more than 10k rows of each is written to disk (for speed). In this case, the expected production file size is printed to the console.</p></li>
<li><p><strong>Upload /input files to Google Drive</strong>. User is prompted in the console to confirm if they would like to upload resulting <code>/input</code> data files to the analogous location in the remote Google Drive storage.</p></li>
<li><p><strong>fusionInput() is finished!</strong> Upon completion, a log file named <code>"inputlog.txt"</code> is written to <code>/input</code> for reference.</p></li>
</ol><p>The user is prompted for console input (including asking about GDrive upload) <em>only</em> if <code><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></code> is <code>TRUE</code>. Otherwise, the steps proceed without user input.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="co"># Since 'test_mode = TRUE' by default, this will affect files in local /fusion_ directory</span></span>
<span><span class="va">dir</span> <span class="op">&lt;-</span> <span class="fu">fusionInput</span><span class="op">(</span>donor <span class="op">=</span> <span class="st">"RECS_2015"</span>,</span>
<span>                   recipient <span class="op">=</span> <span class="st">"ACS_2015"</span>,</span>
<span>                   respondent <span class="op">=</span> <span class="st">"household"</span>,</span>
<span>                   fuse <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"btung"</span>, <span class="st">"btuel"</span>, <span class="st">"cooltype"</span><span class="op">)</span>,</span>
<span>                   force <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"moneypy"</span>, <span class="st">"householder_race"</span>, <span class="st">"education"</span>, <span class="st">"nhsldmem"</span>, <span class="st">"kownrent"</span>, <span class="st">"recs_division"</span><span class="op">)</span>,</span>
<span>                   note <span class="op">=</span> <span class="st">"Hello world. Reminder: running in test mode by default."</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># List files in the target /input directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">dir</span><span class="op">)</span></span>
<span></span></code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Kevin Ummel.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

